---
import Layout from "../../../layout/Layout.astro";
import { PersonneProfessionOptions } from "../../../utils/type";

export const prerender = false;
const { id } = Astro.params;

const personne = await Astro.locals.pb.collection("personne").getOne(id);

// Helper to format various stored date strings into YYYY-MM-DD for <input type="date"> values
function toDateInputValue(val) {
  if (!val) return "";
  const d = new Date(val);
  if (isNaN(d.getTime())) return "";
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

const dateNaissance = toDateInputValue(personne.date_naissance);
const dateDeces = toDateInputValue(personne.date_deces);

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();

  Astro.locals.pb.collection("personne").update(id, data);

  return Astro.redirect(`/personnes/${id}`);
}
---

<Layout>
  <h1>Modifier la page de {personne.prenom} {personne.nom}</h1>
  <form method="POST">
    <label class="block">
      <span>Nom</span>
      <input
        name="nom"
        type="text"
        class="mt-1 block w-full"
        value={personne.nom}
      />
    </label>

    <label class="block">
      <span>Prénom</span>
      <input
        name="prenom"
        type="text"
        class="mt-1 block w-full"
        value={personne.prenom}
      />
    </label>

    <label class="block">
      <span>Date de naissance</span>
      <input
        name="date_naissance"
        type="date"
        class="mt-1 block w-full"
        value={dateNaissance}
      />
    </label>

    <label class="block">
      <span>Date de décès</span>
      <input
        name="date_deces"
        type="date"
        class="mt-1 block w-full"
        value={dateDeces}
      />
    </label>

    <label class="block">
      <span>Nationalité</span>
      <input
        name="nationalite"
        type="text"
        class="mt-1 block w-full"
        value={personne.nationalite || ""}
      />
    </label>

    <label class="block">
      <span>Lieu de naissance</span>
      <input
        name="lieu_naissance"
        type="text"
        class="mt-1 block w-full"
        value={personne.lieu_naissance || ""}
      />
    </label>

    <span>Professions</span>
    <div class="mt-1 space-y-2">
      {
        Object.entries(PersonneProfessionOptions).map(([key, value]) => (
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="profession" value={value} checked={personne.profession.includes(value)}/>
            <span>{key}</span>
          </label>
        ))
      }
    </div>

    <button type="submit">Soumettre</button>
  </form>
</Layout>
